summary: Build (on Ubuntu)
systems: [ubuntu-*]

execute: |
    # Grab builds of Mir git master
    add-apt-repository ppa:mir-team/dev

    apt-get --yes build-dep "${SPREAD_PATH}"
    apt-get --yes install ${EXTRA_PACKAGES}

    # Check that we build…
    cd $SPREAD_PATH
    cd $(mktemp --directory)
    cmake \
      -DCMAKE_C_FLAGS="-D_FORTIFY_SOURCE=2" \
      -DCMAKE_CXX_FLAGS="-D_FORTIFY_SOURCE=2" \
      -DWLCS_BUILD_ASAN=ON \
      -DWLCS_BUILD_UBSAN=ON \
      -DWLCS_BUILD_TSAN=ON \
      $SPREAD_PATH
    make -j$(nproc)

    # …and run the Mir tests, but don't fail on them, unless we fail with a signal
    # TODO: Store the set of passing tests in the Travis cache, and fail if a test which
    #       previously passed now fails.
    for wlcs in wlcs{,.asan,.ubsan,.tsan}; do
      ./${wlcs} /usr/lib/$(dpkg-architecture -qDEB_HOST_MULTIARCH)/mir/miral_wlcs_integration.so || {
          test $? -lt 128 -o $? -gt 165
      }
    done

