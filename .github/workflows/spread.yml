name: Spread

on:
  push:
    branches:
    - master
    - staging
    - trying
    - release/[0-9]+.[0-9]+
    tags:
    - v[0-9]+[0-9]+.[0-9]+
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]

jobs:
  BuildAndTest:
    strategy:
      fail-fast: false
      matrix:
        include:
          - distro: alpine
            release: 3.15
          - distro: alpine
            release: edge
          - distro: fedora
            release: 35
          - distro: fedora
            release: 34
          - distro:: fedora
            release: rawhide
          - distro: ubuntu
            release: 20.04
          - distro: ubuntu
            release: 22.04
          - distro: ubuntu
            release: devel

    runs-on: ubuntu-latest

    env:
      DEBFULLNAME: "Mir CI Bot"
      DEBEMAIL: "mir-ci-bot@canonical.com"

    steps:
    - name: Set up LXD
      uses: whywaita/setup-lxd@v1

    - name: Check out code
      uses: actions/checkout@v3

    - name: Prepare Testbed
      run: |
        set -euo pipefail
        if [[ "${{ matrix.distro }}" -eq "ubuntu" ]]
        then
          if [[ "${{ matrix.release}}" -eq "devel" ]]
          then
            SOURCE=ubuntu-daily:
          else
            SOURCE=ubuntu:
          fi
        else
          SOURCE=images:${{ matrix.distro }}
        fi
        
        CONTAINER=testbed
        lxc launch ${SOURCE}:${{ matrix.release }} ${CONTAINER}
        
        # Mount source into the container
        SOURCEDIR=$(lxc exec ${CONTAINER} -- mktemp --directory)
        echo "SOURCEDIR=${SOURCEDIR}" >> $GITHUB_ENV
        lxc config device add ${CONTAINER} sourcedir disk source=$(pwd) path=${SOURCEDIR}
        lxc restart ${CONTAINER}
      
        sh tools/test/prepare-${{ matrix.distro }}.sh ${CONTAINER}

    - name: Run Tests
      run: |
        set -euo pipefail
        
        sh tools/test/run-${{ matrix.distro }}.sh ${CONTAINER} ${{ env.SOURCEDIR }} $(mktemp --directory)
